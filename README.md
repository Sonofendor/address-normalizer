# Address Normalizer
**Целью данного проекта** было приведение российского адреса, заданного произвольной строкой,
к единому формату по аналогии с [API сервиса Dadata](https://dadata.ru/api/suggest/address/). За основу проекта взят
[репозиторий пользователя shigabeev](https://github.com/shigabeev/address-normalizer).

Задача стандартизации адреса возникла у меня, когда я работал над проектом ЦХД для HR-аналитики.
Адреса регистрации и проиживания сотрудников в разных организациях передавались строкой в разных форматах,
и было нужно привести все к единому виду: например, понять, являются ли строки 
"Россия, 119634, г. Москва, ул. Шолохова, д.7, кв. 221" и "Москва, Шолохова 7, 221" одним и тем же адресом.

Изначально планировалось создать инструмент, совместимый со многими БД и ETL-инструментами, однако
в процессе работы я понял, почему [Dadata](https://dadata.ru/api/clean/address/) возвращает в своем API
список адресов, зачастую даже семантически полный адрес невозможно однозначно стандартизировать (например,
"улица Пушкина, д 1 стр 1" и "улица Пушкина д 1 к 1" являются максимально близкими друг к другу строками, и 
программно выбрать ближайший к исходному запросу результат, точно сказав, что он отличается от второго, почти
невозможно).

Поэтому использовать такое рещение в рамках ЦХД нецелесообразно: а) из-за не 100%-ой точности результатов,
б) из-за медленной работы. В проекте, для которого я разрабатывал это решение, нужно было обрабатывать 400 тысяч
адресов в день. В один поток это считалось около 6 часов. При разделении на несколько потоков, БД не выдерживала
такое количество подключений. Поэтому такое решение лучше использовать как отдельный бэкенд-сервис с балансировщиком 
нагрузки, репликами и одним коннектом к БД на несколько парарллельных задач, 
для подсказок пользователям при заполнении адреса в форме.

## Архитектура проекта
В PostgreSQL при помощи pandas и pszcopg2 загружаются [эталонный справочник почтовых индексов](https://www.pochta.ru/support/database/ops)
и [база данных КЛАДР](https://fias.nalog.ru/Frontend). На их основе формируется широкая таблица public.kladr с индексом 
ts_vector для полнотекстового поиска. 

Из входящей строки извлекаются почтовый индекс и номер дома. Оставшаяся строка токенизируется при помощи NLP-иснтрумента
[Natasha](https://github.com/natasha/natasha). Проверяется валидность почтового индекса при помощи справочника индексов. 
Из токенов собирается поисковый запрос, состоящий из имен собственных и номера дома. Осуществляется поиск по таблице 
при помощи функции PostgreSQL _websearch_to_tsquery_ и почтовому иднексу. Если найден единственный адрес, он считается 
нормализованным адресом. Если не найдено результатов, но почтовый индекс считается валидным, осуществляется вторая попытка поиска,
уже без использования индекса (возможно, он валидный, но относится к другому адресу). Еслли найдено более одного результата,
они возвращаются как "подсказки" (suggestions).

Тестовую выборку и результаты работы можно посмотреть в папке **data/**. Точность на этой выборке приведена в таблице ниже.


### Точность поиска
| БД         | Адресная Система | Найдено точное совпадение | Найдено более одного совпадения | Не найдено совпадений |
|------------|------------------|---------------------------|---------------------------------|-----------------------|
| PostgreSQL | КЛАДР            | 64%                       | 34%                             | 2%                    |

## Использование

Клонировать проект, создать виртуальное окружение, установить зависимости. 
Скачать исходные файлы по ссылкам выше, переименовать в postal_codes.dbf и kladr.7,
поместить в директорию data/raw. Обновить данные командами 
```
python update_data.py postal_codes
python update_data.py kladr
```
Примеры использования можно увидеть в файле **examples.py**
